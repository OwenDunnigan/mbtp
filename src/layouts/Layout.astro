---
import "../styles/main.sass";

interface Props {
	title: string;
}

const { title } = Astro.props;
import { ClientRouter } from "astro:transitions";
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Astro description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<ClientRouter />
	</head>
	<body>
		<slot />
		<script>
			// Define transition logic in a robust way that survives re-runs
			// We attach functions to window so we can reference them for removal

			declare global {
				interface Window {
					obsidianTransitionLogic: {
						currentTransition: string;
						cleanupTimer: NodeJS.Timeout | null;
						handleBeforePreparation: (event: {
							from: URL;
							to: URL;
							navigationType: string;
						}) => void;
						handleBeforeSwap: (event: {
							newDocument: Document;
						}) => void;
						handlePageLoad: () => void;
					};
				}
			}

			if (!window.obsidianTransitionLogic) {
				window.obsidianTransitionLogic = {
					currentTransition: "",
					cleanupTimer: null,

					handleBeforePreparation: (event) => {
						// Cancel any pending cleanup from previous navigations to prevent race conditions
						if (window.obsidianTransitionLogic.cleanupTimer) {
							clearTimeout(
								window.obsidianTransitionLogic.cleanupTimer,
							);
							window.obsidianTransitionLogic.cleanupTimer = null;
						}

						// Use event.from for source of truth, fallback to current location
						const fromUrl = event.from || new URL(location.href);
						const toUrl = event.to; // event.to is a URL object by default in Astro 5

						const fromPath =
							fromUrl.pathname.replace(/\/$/, "") || "/";
						const toPath = toUrl.pathname.replace(/\/$/, "") || "/";
						const html = document.documentElement;
						const navType = event.navigationType; // 'push', 'replace', 'traverse'

						console.log(
							"Navigating from:",
							fromPath,
							"to:",
							toPath,
							"Type:",
							navType,
						);

						let type = "";

						// Forward Navigations
						if (toPath.startsWith("/lunch")) {
							type = "lunch";
						} else if (toPath.startsWith("/dinner")) {
							type = "dinner";
						}
						// Backward Navigations (Returning to Home)
						else if (toPath === "/" || toPath === "") {
							// If we are coming BACK to home
							console.log(
								"Returning to home. Checking origin path:",
								fromPath,
							);
							if (fromPath.includes("/lunch")) {
								type = "lunch-back";
							} else if (fromPath.includes("/dinner")) {
								type = "dinner-back";
							}
						}

						console.log(
							"Transition Decision. From:",
							fromPath,
							"To:",
							toPath,
							"Type:",
							type,
						);

						// Apply transition
						window.obsidianTransitionLogic.currentTransition = type;
						html.dataset.transitionTo = type;
					},

					handleBeforeSwap: (event) => {
						const type =
							window.obsidianTransitionLogic.currentTransition;
						console.log("Transferring transition:", type);
						event.newDocument.documentElement.dataset.transitionTo =
							type;
					},

					handlePageLoad: () => {
						// Store timer ID to allow cancellation
						window.obsidianTransitionLogic.cleanupTimer =
							setTimeout(() => {
								document.documentElement.dataset.transitionTo =
									"";
								window.obsidianTransitionLogic.currentTransition =
									"";
							}, 2500); // 2.5s coverage
					},
				};
			}

			// Remove existing listeners to prevent stacking
			const logic = window.obsidianTransitionLogic;
			document.removeEventListener(
				"astro:before-preparation",
				logic.handleBeforePreparation,
			);
			document.removeEventListener(
				"astro:before-swap",
				logic.handleBeforeSwap,
			);
			document.removeEventListener(
				"astro:page-load",
				logic.handlePageLoad,
			);

			// Add listeners
			document.addEventListener(
				"astro:before-preparation",
				logic.handleBeforePreparation,
			);
			document.addEventListener(
				"astro:before-swap",
				logic.handleBeforeSwap,
			);
			document.addEventListener("astro:page-load", logic.handlePageLoad);
		</script>
		<style is:global>
			/* 3D Blob Animation Layer - Moved to Layout for persistence */
		</style>
	</body>
</html>
